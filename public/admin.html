<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SempÃ©ra Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Jost:wght@200;300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --gold:#b8965a;--gold-light:#d4b07a;--gold-pale:#f5ead8;
  --dark:#1a1208;--ink:#2c2416;--muted:#7a6a52;
  --border:#e8d5b0;--bg:#fdfaf5;--white:#ffffff;
  --sidebar:220px;
  --status-new:#3b82f6;--status-contacted:#f97316;--status-confirmed:#8b5cf6;
  --status-payment:#06b6d4;--status-production:#eab308;--status-ready:#10b981;
  --status-delivered:#16a34a;--status-cancelled:#ef4444;
}
body{font-family:'Jost',sans-serif;background:#f4f0eb;color:var(--ink);min-height:100vh;}

/* â”€â”€ AUTH â”€â”€ */
#auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--dark);}
.auth-box{background:var(--white);padding:48px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.auth-logo{font-family:'Cormorant Garamond',serif;font-size:2.4rem;font-weight:300;color:var(--dark);letter-spacing:0.1em;text-align:center;margin-bottom:4px;}
.auth-logo span{color:var(--gold);}
.auth-sub{text-align:center;font-size:0.62rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--muted);margin-bottom:36px;}
.auth-box input{width:100%;padding:12px 16px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.875rem;outline:none;margin-bottom:12px;background:var(--bg);}
.auth-box input:focus{border-color:var(--gold);}
.btn-gold{background:var(--gold);color:white;border:none;padding:12px 24px;font-family:'Jost',sans-serif;font-size:0.7rem;letter-spacing:0.18em;text-transform:uppercase;cursor:pointer;transition:background 0.2s;width:100%;}
.btn-gold:hover{background:var(--dark);}
.auth-error{color:#ef4444;font-size:0.78rem;text-align:center;margin-top:8px;min-height:20px;}

/* â”€â”€ LAYOUT â”€â”€ */
#app{display:none;min-height:100vh;}
.layout{display:flex;min-height:100vh;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:var(--sidebar);background:var(--dark);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;}
.sidebar-logo{padding:28px 24px 20px;border-bottom:1px solid rgba(184,150,90,0.2);}
.sidebar-logo-text{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;color:white;letter-spacing:0.08em;}
.sidebar-logo-text span{color:var(--gold);}
.sidebar-label{font-size:0.5rem;letter-spacing:0.25em;text-transform:uppercase;color:rgba(184,150,90,0.6);margin-top:3px;}
.sidebar-nav{flex:1;padding:20px 0;}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 24px;cursor:pointer;transition:all 0.2s;font-size:0.82rem;letter-spacing:0.06em;color:rgba(255,255,255,0.55);border-left:3px solid transparent;}
.nav-item:hover{color:white;background:rgba(184,150,90,0.08);}
.nav-item.active{color:var(--gold);background:rgba(184,150,90,0.12);border-left-color:var(--gold);}
.nav-icon{font-size:1rem;width:20px;text-align:center;}
.sidebar-footer{padding:20px 24px;border-top:1px solid rgba(184,150,90,0.2);}
.logout-btn{display:flex;align-items:center;gap:10px;font-size:0.75rem;color:rgba(255,255,255,0.4);cursor:pointer;background:none;border:none;font-family:'Jost',sans-serif;letter-spacing:0.08em;}
.logout-btn:hover{color:rgba(255,255,255,0.7);}

/* â”€â”€ MAIN â”€â”€ */
.main{margin-left:var(--sidebar);flex:1;min-height:100vh;}
.topbar{background:white;padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
.topbar-title{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:400;color:var(--dark);}
.topbar-right{display:flex;align-items:center;gap:16px;}
.admin-badge{font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);background:var(--gold-pale);padding:4px 12px;border:1px solid var(--border);}
.page-content{padding:32px;display:none;}
.page-content.active{display:block;}

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px;}
.stat-card{background:white;padding:20px;border:1px solid var(--border);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--dark),var(--gold));}
.stat-icon{font-size:1.4rem;margin-bottom:10px;}
.stat-label{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.stat-value{font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:500;color:var(--dark);line-height:1;}
.stat-sub{font-size:0.7rem;color:var(--muted);margin-top:4px;}

/* â”€â”€ CHARTS â”€â”€ */
.charts-row{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:28px;}
.chart-card{background:white;padding:24px;border:1px solid var(--border);}
.chart-card.full{grid-column:1/-1;}
.chart-title{font-size:0.65rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold);margin-bottom:4px;}
.chart-heading{font-family:'Cormorant Garamond',serif;font-size:1.15rem;color:var(--dark);margin-bottom:16px;}
.filter-tabs{display:flex;gap:8px;margin-bottom:16px;}
.filter-tab{padding:4px 12px;font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;border:1px solid var(--border);background:none;cursor:pointer;font-family:'Jost',sans-serif;color:var(--muted);transition:all 0.15s;}
.filter-tab.active{background:var(--gold);color:white;border-color:var(--gold);}

/* â”€â”€ CONVERSION â”€â”€ */
.conversion-box{display:flex;align-items:center;gap:24px;padding:16px;background:var(--bg);border:1px solid var(--border);}
.conv-num{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;color:var(--dark);}
.conv-label{font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);}
.conv-arrow{font-size:1.5rem;color:var(--gold);}
.conv-rate{font-family:'Cormorant Garamond',serif;font-size:2.5rem;font-weight:500;color:var(--gold);}

/* â”€â”€ TABLES â”€â”€ */
.table-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
.table-header h2{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:400;color:var(--dark);}
.search-box{padding:8px 16px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.8rem;outline:none;width:220px;background:white;}
.search-box:focus{border-color:var(--gold);}
.table-wrap{background:white;border:1px solid var(--border);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:2px solid var(--gold);}
th{padding:12px 16px;text-align:left;font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);font-weight:500;white-space:nowrap;}
td{padding:12px 16px;font-size:0.8rem;color:var(--ink);border-bottom:1px solid #f5ede0;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#fdfaf5;}
.table-empty{text-align:center;padding:48px;color:var(--muted);font-size:0.85rem;}

/* â”€â”€ STATUS BADGES â”€â”€ */
.badge{display:inline-block;padding:3px 10px;font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;font-weight:500;border-radius:2px;}
.badge-new{background:#dbeafe;color:#1d4ed8;}
.badge-contacted{background:#ffedd5;color:#c2410c;}
.badge-confirmed{background:#ede9fe;color:#6d28d9;}
.badge-payment{background:#cffafe;color:#0e7490;}
.badge-production{background:#fef9c3;color:#a16207;}
.badge-ready{background:#d1fae5;color:#065f46;}
.badge-delivered{background:#bbf7d0;color:#14532d;}
.badge-cancelled{background:#fee2e2;color:#991b1b;}

/* â”€â”€ ACTION BUTTONS â”€â”€ */
.btn-sm{padding:5px 12px;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;border:1px solid var(--border);background:white;cursor:pointer;font-family:'Jost',sans-serif;transition:all 0.15s;color:var(--ink);}
.btn-sm:hover{border-color:var(--gold);color:var(--gold);}
.btn-sm.danger:hover{border-color:#ef4444;color:#ef4444;}
.btn-gold-sm{padding:5px 14px;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;border:none;background:var(--gold);color:white;cursor:pointer;font-family:'Jost',sans-serif;transition:background 0.15s;}
.btn-gold-sm:hover{background:var(--dark);}

/* â”€â”€ SELECT â”€â”€ */
select.status-select{padding:4px 8px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.72rem;background:white;cursor:pointer;outline:none;color:var(--ink);}
select.status-select:focus{border-color:var(--gold);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:white;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;}
.modal-header{padding:24px 28px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.modal-header h3{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:400;}
.modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);padding:4px;}
.modal-close:hover{color:var(--ink);}
.modal-body{padding:24px 28px;}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.info-group{margin-bottom:16px;}
.info-label{font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);margin-bottom:4px;}
.info-value{font-size:0.88rem;color:var(--ink);font-weight:400;}
.modal-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.modal-section:last-child{border-bottom:none;margin-bottom:0;}
.modal-section-title{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
textarea.note-input{width:100%;padding:10px 14px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.82rem;resize:vertical;min-height:80px;outline:none;}
textarea.note-input:focus{border-color:var(--gold);}
.modal-actions{display:flex;gap:10px;flex-wrap:wrap;padding-top:16px;}

/* â”€â”€ PRODUCT GRID â”€â”€ */
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
.product-admin-card{background:white;border:1px solid var(--border);overflow:hidden;transition:box-shadow 0.2s;}
.product-admin-card:hover{box-shadow:0 4px 20px rgba(184,150,90,0.15);}
.product-card-img{width:100%;aspect-ratio:3/4;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--border);}
.product-card-body{padding:14px;}
.product-card-code{font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.product-card-name{font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:500;color:var(--dark);margin-bottom:6px;line-height:1.3;}
.product-card-price{font-size:0.85rem;color:var(--gold);font-weight:500;margin-bottom:10px;}
.product-card-actions{display:flex;gap:8px;}

/* â”€â”€ FORM â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-group{margin-bottom:0;}
.form-group.full{grid-column:1/-1;}
.form-label{display:block;font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.form-input{width:100%;padding:10px 14px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.82rem;background:white;outline:none;}
.form-input:focus{border-color:var(--gold);}
textarea.form-input{resize:vertical;min-height:80px;}
.form-section{background:white;border:1px solid var(--border);padding:24px;margin-bottom:20px;}
.form-section-title{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border);}

/* â”€â”€ LOADING â”€â”€ */
.loading{text-align:center;padding:48px;color:var(--muted);}
.spinner{display:inline-block;width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;margin-bottom:10px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:24px;right:24px;background:var(--dark);color:white;padding:12px 20px;font-size:0.78rem;letter-spacing:0.06em;z-index:999;transform:translateY(100px);opacity:0;transition:all 0.3s;pointer-events:none;}
#toast.show{transform:translateY(0);opacity:1;}
#toast.success{border-left:3px solid var(--gold);}
#toast.error{border-left:3px solid #ef4444;}

/* â”€â”€ CUSTOMER TAGS â”€â”€ */
.tag{display:inline-block;padding:2px 8px;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;border-radius:2px;}
.tag-vip{background:#fef3c7;color:#92400e;}
.tag-repeat{background:#ede9fe;color:#5b21b6;}
.tag-high{background:#d1fae5;color:#065f46;}
.tag-regular{background:#f1f5f9;color:#475569;}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;}
  .charts-row{grid-template-columns:1fr;}
  .modal-grid,.form-grid{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
}

.section-stripe{height:3px;background:linear-gradient(90deg,var(--dark),var(--gold),var(--dark));margin-bottom:28px;}
</style>
</head>
<body>

<!-- â•â•â• AUTH SCREEN â•â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">semp<span>Ã©</span>ra</div>
    <div class="auth-sub">Admin Dashboard</div>
    <input type="email" id="auth-email" placeholder="Email address" autocomplete="email"/>
    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password"/>
    <button class="btn-gold" onclick="handleLogin()">Sign In</button>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- â•â•â• MAIN APP â•â•â• -->
<div id="app">
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-text">semp<span>Ã©</span>ra</div>
        <div class="sidebar-label">Admin Panel</div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-item active" onclick="showPage('dashboard')">
          <span class="nav-icon">ğŸ“Š</span> Dashboard
        </div>
        <div class="nav-item" onclick="showPage('orders')">
          <span class="nav-icon">ğŸ“¦</span> Orders
        </div>
        <div class="nav-item" onclick="showPage('products')">
          <span class="nav-icon">ğŸ‘—</span> Products
        </div>
        <div class="nav-item" onclick="showPage('customers')">
          <span class="nav-icon">ğŸ‘©ğŸ½â€ğŸ’¼</span> Customers
        </div>
      </nav>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="handleLogout()">
          <span>â‹</span> Sign Out
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="topbar-title" id="page-title">Dashboard</div>
        <div class="topbar-right">
          <span class="admin-badge">SempÃ©ra Admin</span>
          <span id="topbar-user" style="font-size:0.75rem;color:var(--muted);"></span>
        </div>
      </div>

      <!-- â•â•â• DASHBOARD PAGE â•â•â• -->
      <div class="page-content active" id="page-dashboard">
        <div class="section-stripe"></div>

        <!-- Stat Cards -->
        <div class="stats-grid" id="stats-grid">
          <div class="stat-card"><div class="stat-icon">ğŸ“‹</div><div class="stat-label">Total Requests (Month)</div><div class="stat-value" id="stat-month">â€“</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ“…</div><div class="stat-label">Total Requests (Week)</div><div class="stat-value" id="stat-week">â€“</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸŒ…</div><div class="stat-label">Today's Requests</div><div class="stat-value" id="stat-today">â€“</div></div>
          <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-label">Confirmed Orders</div><div class="stat-value" id="stat-confirmed">â€“</div></div>
          <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-label">Pending Requests</div><div class="stat-value" id="stat-pending">â€“</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Most Popular Product</div><div class="stat-value" style="font-size:1rem;margin-top:4px;" id="stat-popular">â€“</div></div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-title">Analytics</div>
            <div class="chart-heading">Orders Over Time</div>
            <div class="filter-tabs">
              <button class="filter-tab active" onclick="setChartFilter(7,this)">7 Days</button>
              <button class="filter-tab" onclick="setChartFilter(30,this)">30 Days</button>
              <button class="filter-tab" onclick="setChartFilter(90,this)">90 Days</button>
            </div>
            <canvas id="ordersChart" height="180"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Conversion</div>
            <div class="chart-heading">Request â†’ Order Rate</div>
            <canvas id="conversionChart" height="180"></canvas>
            <div class="conversion-box" style="margin-top:16px;" id="conv-box">
              <div><div class="conv-label">Requests</div><div class="conv-num" id="conv-total">â€“</div></div>
              <div class="conv-arrow">â†’</div>
              <div><div class="conv-label">Confirmed</div><div class="conv-num" id="conv-confirmed">â€“</div></div>
              <div class="conv-arrow">=</div>
              <div><div class="conv-label">Rate</div><div class="conv-rate" id="conv-rate">â€“</div></div>
            </div>
          </div>
        </div>

        <!-- Bottom Charts -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-title">Products</div>
            <div class="chart-heading">Top 5 Most Requested</div>
            <canvas id="productsChart" height="180"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Sizes</div>
            <div class="chart-heading">Size Demand Distribution</div>
            <canvas id="sizesChart" height="180"></canvas>
          </div>
        </div>
      </div>

      <!-- â•â•â• ORDERS PAGE â•â•â• -->
      <div class="page-content" id="page-orders">
        <div class="section-stripe"></div>
        <div class="table-header">
          <h2>Order Requests</h2>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <select id="orders-filter" onchange="filterOrders()" style="padding:8px 12px;border:1px solid var(--border);font-family:'Jost',sans-serif;font-size:0.78rem;outline:none;background:white;">
              <option value="">All Statuses</option>
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="confirmed">Confirmed</option>
              <option value="payment">Payment Received</option>
              <option value="production">In Production</option>
              <option value="ready">Ready</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <input class="search-box" placeholder="Search name, product..." id="orders-search" oninput="filterOrders()"/>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Product</th>
                <th>Size</th>
                <th>Qty</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="orders-tbody">
              <tr><td colspan="9" class="table-empty"><div class="spinner"></div><br/>Loading orders...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â•â•â• PRODUCTS PAGE â•â•â• -->
      <div class="page-content" id="page-products">
        <div class="section-stripe"></div>
        <div class="table-header">
          <h2>Products</h2>
          <div style="display:flex;gap:10px;">
            <input class="search-box" placeholder="Search products..." id="products-search" oninput="filterProducts()"/>
            <button class="btn-gold-sm" onclick="openProductForm(null)">+ Add Product</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Price</th>
                <th>Original</th>
                <th>Sizes</th>
                <th>Status</th>
                <th>Requests</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <tr><td colspan="8" class="table-empty"><div class="spinner"></div><br/>Loading products...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â•â•â• CUSTOMERS PAGE â•â•â• -->
      <div class="page-content" id="page-customers">
        <div class="section-stripe"></div>
        <div class="table-header">
          <h2>Customers</h2>
          <input class="search-box" placeholder="Search customers..." id="customers-search" oninput="filterCustomers()"/>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Total Orders</th>
                <th>Preferred Size</th>
                <th>Last Order</th>
                <th>Tags</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="customers-tbody">
              <tr><td colspan="8" class="table-empty"><div class="spinner"></div><br/>Loading customers...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- â•â•â• ORDER DETAIL MODAL â•â•â• -->
<div class="modal-overlay" id="order-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-order-title">Order Detail</h3>
      <button class="modal-close" onclick="closeModal('order-modal')">âœ•</button>
    </div>
    <div class="modal-body" id="order-modal-body"></div>
  </div>
</div>

<!-- â•â•â• CUSTOMER DETAIL MODAL â•â•â• -->
<div class="modal-overlay" id="customer-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-customer-title">Customer Profile</h3>
      <button class="modal-close" onclick="closeModal('customer-modal')">âœ•</button>
    </div>
    <div class="modal-body" id="customer-modal-body"></div>
  </div>
</div>

<!-- â•â•â• PRODUCT FORM MODAL â•â•â• -->
<div class="modal-overlay" id="product-modal">
  <div class="modal" style="max-width:720px;">
    <div class="modal-header">
      <h3 id="modal-product-title">Add Product</h3>
      <button class="modal-close" onclick="closeModal('product-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">Product Details</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Product Name *</label><input class="form-input" id="pf-name" placeholder="e.g. Metallic Blue Dress"/></div>
          <div class="form-group"><label class="form-label">Product Code *</label><input class="form-input" id="pf-code" placeholder="e.g. SP-EL-016"/></div>
          <div class="form-group"><label class="form-label">Price *</label><input class="form-input" id="pf-price" placeholder="â‚¦34,999"/></div>
          <div class="form-group"><label class="form-label">Original Price</label><input class="form-input" id="pf-original" placeholder="â‚¦39,999"/></div>
          <div class="form-group"><label class="form-label">Available Sizes</label><input class="form-input" id="pf-sizes" placeholder="6â€“22"/></div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="pf-status">
              <option value="active">Active</option>
              <option value="soldout">Sold Out</option>
              <option value="hidden">Hidden</option>
            </select>
          </div>
          <div class="form-group full"><label class="form-label">Description</label><textarea class="form-input" id="pf-description" placeholder="Product description..."></textarea></div>
          <div class="form-group full"><label class="form-label">Fabric Details</label><textarea class="form-input" id="pf-fabric" placeholder="Fabric composition..."></textarea></div>
          <div class="form-group full"><label class="form-label">Care Instructions</label><textarea class="form-input" id="pf-care" placeholder="Care instructions..."></textarea></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button class="btn-sm" onclick="closeModal('product-modal')">Cancel</button>
        <button class="btn-gold-sm" onclick="saveProduct()" style="padding:10px 24px;">Save Product</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://sieqvcjiqdjhjnxaslrd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpZXF2Y2ppcWRqaGpueGFzbHJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4Nzk4NjIsImV4cCI6MjA4NzQ1NTg2Mn0.E1VkbPUJ9_u_pyhIXMZb5WWrXYQvIdEY-z3dIqZp7Mc';

const HEADERS = {
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Content-Type': 'application/json',
  'Prefer': 'return=representation'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allOrders = [];
let allProducts = [];
let allCustomers = [];
let editingProductId = null;
let chartInstance = null;
let currentChartDays = 7;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sb(path, options = {}) {
  // Always build fresh headers using the latest auth token
  const freshHeaders = {
    'apikey': SUPABASE_KEY,
    'Authorization': HEADERS['Authorization'],
    'Content-Type': 'application/json',
    'Prefer': (options.method === 'POST') ? 'return=representation' : 'return=minimal',
  };
  const { headers: _h, ...restOptions } = options;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: freshHeaders,
    ...restOptions
  });
  if (!res.ok) {
    const err = await res.text();
    console.error('Supabase error:', res.status, err);
    throw new Error(`${res.status}: ${err}`);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function sbAuth(endpoint, body) {
  const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
    method: 'POST',
    headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;

async function handleLogin() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-error');
  errEl.textContent = '';

  if (!email || !password) { errEl.textContent = 'Please enter email and password.'; return; }

  const data = await sbAuth('token?grant_type=password', { email, password });

  if (data.error || !data.access_token) {
    errEl.textContent = data.error_description || 'Invalid credentials.';
    return;
  }

  currentUser = data.user;
  HEADERS['Authorization'] = `Bearer ${data.access_token}`;
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('topbar-user').textContent = email;
  await initApp();
}

function handleLogout() {
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('auth-password').value = '';
}

// Allow Enter key on login
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('auth-screen').style.display !== 'none') handleLogin();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(page) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  event.currentTarget.classList.add('active');
  const titles = { dashboard:'Dashboard', orders:'Orders & Requests', products:'Product Management', customers:'Customer Management' };
  document.getElementById('page-title').textContent = titles[page];
  if (page === 'orders') renderOrders();
  if (page === 'products') renderProducts();
  if (page === 'customers') renderCustomers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  await Promise.all([loadOrders(), loadProducts(), loadCustomers()]);
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadOrders() {
  try {
    allOrders = await sb('orders?select=*&order=created_at.desc') || [];
  } catch(e) { allOrders = []; showToast('Could not load orders', 'error'); }
}

async function loadProducts() {
  try {
    allProducts = await sb('products?select=*&order=code.asc') || [];
  } catch(e) { allProducts = []; }
}

async function loadCustomers() {
  try {
    allCustomers = await sb('customers?select=*&order=created_at.desc') || [];
  } catch(e) { allCustomers = []; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const now = new Date();
  const startOfDay = new Date(now); startOfDay.setHours(0,0,0,0);
  const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - 7);
  const startOfMonth = new Date(now); startOfMonth.setDate(now.getDate() - 30);

  const todayOrders = allOrders.filter(o => new Date(o.created_at) >= startOfDay);
  const weekOrders = allOrders.filter(o => new Date(o.created_at) >= startOfWeek);
  const monthOrders = allOrders.filter(o => new Date(o.created_at) >= startOfMonth);
  const confirmed = allOrders.filter(o => ['confirmed','payment','production','ready','delivered'].includes(o.status));
  const pending = allOrders.filter(o => ['new','contacted'].includes(o.status));

  document.getElementById('stat-month').textContent = monthOrders.length;
  document.getElementById('stat-week').textContent = weekOrders.length;
  document.getElementById('stat-today').textContent = todayOrders.length;
  document.getElementById('stat-confirmed').textContent = confirmed.length;
  document.getElementById('stat-pending').textContent = pending.length;

  // Most popular product
  const productCounts = {};
  allOrders.forEach(o => { productCounts[o.product_name] = (productCounts[o.product_name]||0)+1; });
  const topProduct = Object.entries(productCounts).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('stat-popular').textContent = topProduct ? `${topProduct[0].split(' ').slice(0,3).join(' ')} (${topProduct[1]})` : 'No data yet';

  // Conversion
  const total = allOrders.length;
  const conf = confirmed.length;
  const rate = total > 0 ? Math.round((conf/total)*100) : 0;
  document.getElementById('conv-total').textContent = total;
  document.getElementById('conv-confirmed').textContent = conf;
  document.getElementById('conv-rate').textContent = `${rate}%`;

  buildOrdersChart(currentChartDays);
  buildConversionChart(rate);
  buildProductsChart();
  buildSizesChart();
}

function buildOrdersChart(days) {
  const ctx = document.getElementById('ordersChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  const labels = [];
  const data = [];
  const now = new Date();

  for (let i = days-1; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    const label = d.toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
    labels.push(label);
    const start = new Date(d); start.setHours(0,0,0,0);
    const end = new Date(d); end.setHours(23,59,59,999);
    data.push(allOrders.filter(o => { const t = new Date(o.created_at); return t >= start && t <= end; }).length);
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Orders',
        data,
        borderColor: '#b8965a',
        backgroundColor: 'rgba(184,150,90,0.08)',
        borderWidth: 2,
        pointBackgroundColor: '#b8965a',
        pointRadius: 3,
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{stepSize:1} } } }
  });
}

function buildConversionChart(rate) {
  const ctx = document.getElementById('conversionChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Converted', 'Pending'],
      datasets: [{ data: [rate, 100-rate], backgroundColor: ['#b8965a','#f5ead8'], borderWidth: 0 }]
    },
    options: { responsive:true, cutout:'70%', plugins:{ legend:{display:false} } }
  });
}

function buildProductsChart() {
  const ctx = document.getElementById('productsChart').getContext('2d');
  const counts = {};
  allOrders.forEach(o => { counts[o.product_code||o.product_name] = (counts[o.product_code||o.product_name]||0)+1; });
  const top5 = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);

  if (top5.length === 0) {
    // Show placeholder with all products
    const labels = allProducts.slice(0,5).map(p => p.code);
    const data = labels.map(() => 0);
    new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'rgba(184,150,90,0.3)', borderColor:'#b8965a', borderWidth:1 }] }, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}}} } });
    return;
  }

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top5.map(e=>e[0]),
      datasets: [{ label:'Requests', data:top5.map(e=>e[1]), backgroundColor:'rgba(184,150,90,0.6)', borderColor:'#b8965a', borderWidth:1 }]
    },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}}} }
  });
}

function buildSizesChart() {
  const ctx = document.getElementById('sizesChart').getContext('2d');
  const sizeCounts = {};
  allOrders.forEach(o => { if (o.size) sizeCounts[o.size] = (sizeCounts[o.size]||0)+(o.quantity||1); });

  const sizes = Object.keys(sizeCounts).length > 0
    ? Object.keys(sizeCounts).sort()
    : ['6','8','10','12','14','16','18','20','22'];
  const data = sizes.map(s => sizeCounts[s]||0);
  const colors = ['#f5ead8','#e8d5b0','#d4b07a','#b8965a','#9a7a42','#7d6135','#5f4928','#42321b','#2c2416'];

  new Chart(ctx, {
    type: 'doughnut',
    data: { labels:sizes, datasets:[{ data, backgroundColor:colors.slice(0,sizes.length), borderWidth:1, borderColor:'white' }] },
    options: { responsive:true, plugins:{ legend:{ position:'right', labels:{ font:{size:10}, padding:8 } } } }
  });
}

function setChartFilter(days, btn) {
  currentChartDays = days;
  document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  buildOrdersChart(days);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOrders(data) {
  const orders = data || allOrders;
  const tbody = document.getElementById('orders-tbody');
  if (!orders.length) { tbody.innerHTML = '<tr><td colspan="9" class="table-empty">No orders found.</td></tr>'; return; }

  tbody.innerHTML = orders.map(o => `
    <tr>
      <td style="font-size:0.7rem;color:var(--muted);">${o.id.slice(0,8)}...</td>
      <td><strong>${esc(o.customer_name)}</strong></td>
      <td>
        <div style="font-size:0.8rem;">${esc(o.product_name||'')}</div>
        <div style="font-size:0.65rem;color:var(--muted);">${esc(o.product_code||'')}</div>
      </td>
      <td>${esc(o.size||'â€“')}</td>
      <td>${o.quantity||1}</td>
      <td>${esc(o.customer_phone||'â€“')}</td>
      <td>
        <select class="status-select" onchange="updateOrderStatus('${o.id}',this.value)">
          ${['new','contacted','confirmed','payment','production','ready','delivered','cancelled'].map(s=>
            `<option value="${s}" ${o.status===s?'selected':''}>${statusLabel(s)}</option>`
          ).join('')}
        </select>
      </td>
      <td style="font-size:0.75rem;white-space:nowrap;">${formatDate(o.created_at)}</td>
      <td>
        <button class="btn-sm" onclick="openOrderModal('${o.id}')">View</button>
      </td>
    </tr>
  `).join('');
}

function filterOrders() {
  const search = document.getElementById('orders-search').value.toLowerCase();
  const status = document.getElementById('orders-filter').value;
  const filtered = allOrders.filter(o => {
    const matchSearch = !search ||
      (o.customer_name||'').toLowerCase().includes(search) ||
      (o.product_name||'').toLowerCase().includes(search) ||
      (o.customer_phone||'').includes(search);
    const matchStatus = !status || o.status === status;
    return matchSearch && matchStatus;
  });
  renderOrders(filtered);
}

async function updateOrderStatus(id, status) {
  try {
    await sb(`orders?id=eq.${id}`, { method:'PATCH', body: JSON.stringify({ status }) });
    const idx = allOrders.findIndex(o => o.id === id);
    if (idx > -1) allOrders[idx].status = status;
    showToast('Status updated âœ“');
  } catch(e) { showToast('Failed to update status', 'error'); }
}

function openOrderModal(id) {
  const o = allOrders.find(x => x.id === id);
  if (!o) return;
  document.getElementById('modal-order-title').textContent = `Order â€” ${o.customer_name}`;
  document.getElementById('order-modal-body').innerHTML = `
    <div class="modal-section">
      <div class="modal-section-title">Customer Information</div>
      <div class="modal-grid">
        <div class="info-group"><div class="info-label">Name</div><div class="info-value">${esc(o.customer_name)}</div></div>
        <div class="info-group"><div class="info-label">Phone</div><div class="info-value">${esc(o.customer_phone||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Email</div><div class="info-value">${esc(o.customer_email||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Date</div><div class="info-value">${formatDate(o.created_at)}</div></div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Order Information</div>
      <div class="modal-grid">
        <div class="info-group"><div class="info-label">Product</div><div class="info-value">${esc(o.product_name||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Code</div><div class="info-value">${esc(o.product_code||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Size</div><div class="info-value">${esc(o.size||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Quantity</div><div class="info-value">${o.quantity||1}</div></div>
        <div class="info-group"><div class="info-label">Price</div><div class="info-value" style="color:var(--gold)">${esc(o.product_price||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Status</div><div class="info-value"><span class="badge badge-${o.status}">${statusLabel(o.status)}</span></div></div>
      </div>
      ${o.notes ? `<div class="info-group" style="margin-top:12px;"><div class="info-label">Customer Notes</div><div class="info-value" style="background:var(--bg);padding:10px;font-size:0.82rem;">${esc(o.notes)}</div></div>` : ''}
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Internal Note</div>
      <textarea class="note-input" id="modal-note-input" placeholder="Add internal note...">${esc(o.internal_note||'')}</textarea>
    </div>
    <div class="modal-actions">
      <select class="status-select" id="modal-status-select" style="padding:8px 12px;">
        ${['new','contacted','confirmed','payment','production','ready','delivered','cancelled'].map(s=>
          `<option value="${s}" ${o.status===s?'selected':''}>${statusLabel(s)}</option>`
        ).join('')}
      </select>
      <button class="btn-gold-sm" onclick="saveOrderFromModal('${o.id}')">Save Changes</button>
      <a href="https://wa.me/${(o.customer_phone||'').replace(/\D/g,'')}?text=${encodeURIComponent(`Hello ${o.customer_name}, regarding your order for ${o.product_name}...`)}" target="_blank" class="btn-sm" style="text-decoration:none;display:inline-flex;align-items:center;">ğŸ’¬ WhatsApp</a>
    </div>
  `;
  document.getElementById('order-modal').classList.add('open');
}

async function saveOrderFromModal(id) {
  const status = document.getElementById('modal-status-select').value;
  const note = document.getElementById('modal-note-input').value;
  try {
    await sb(`orders?id=eq.${id}`, { method:'PATCH', body: JSON.stringify({ status, internal_note: note }) });
    const idx = allOrders.findIndex(o => o.id === id);
    if (idx > -1) { allOrders[idx].status = status; allOrders[idx].internal_note = note; }
    closeModal('order-modal');
    renderOrders();
    showToast('Order updated âœ“');
  } catch(e) { showToast('Failed to save', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProducts(data) {
  const products = data || allProducts;
  const tbody = document.getElementById('products-tbody');
  if (!products.length) { tbody.innerHTML = '<tr><td colspan="8" class="table-empty">No products found.</td></tr>'; return; }

  tbody.innerHTML = products.map(p => `
    <tr>
      <td style="font-size:0.72rem;font-weight:500;">${esc(p.code)}</td>
      <td>
        <div style="font-weight:400;">${esc(p.name)}</div>
        <div style="font-size:0.7rem;color:var(--muted);">${esc(p.fabric||'')}</div>
      </td>
      <td style="color:var(--gold);font-weight:500;">${esc(p.price||'â€“')}</td>
      <td style="text-decoration:line-through;color:var(--muted);font-size:0.78rem;">${esc(p.original_price||'â€“')}</td>
      <td>${esc(p.sizes||'â€“')}</td>
      <td><span class="badge ${p.status==='active'?'badge-delivered':p.status==='soldout'?'badge-cancelled':'badge-contacted'}">${p.status||'active'}</span></td>
      <td>${p.total_requests||0}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn-sm" onclick="openProductForm('${p.id}')">Edit</button>
        <button class="btn-sm danger" onclick="toggleProductStatus('${p.id}','${p.status}')">${p.status==='active'?'Hide':'Show'}</button>
      </td>
    </tr>
  `).join('');
}

function filterProducts() {
  const q = document.getElementById('products-search').value.toLowerCase();
  renderProducts(allProducts.filter(p =>
    (p.name||'').toLowerCase().includes(q) || (p.code||'').toLowerCase().includes(q)
  ));
}

function openProductForm(id) {
  editingProductId = id;
  const p = id ? allProducts.find(x => x.id === id) : null;
  document.getElementById('modal-product-title').textContent = p ? `Edit â€” ${p.code}` : 'Add Product';
  document.getElementById('pf-name').value = p?.name || '';
  document.getElementById('pf-code').value = p?.code || '';
  document.getElementById('pf-price').value = p?.price || '';
  document.getElementById('pf-original').value = p?.original_price || '';
  document.getElementById('pf-sizes').value = p?.sizes || '6â€“22';
  document.getElementById('pf-status').value = p?.status || 'active';
  document.getElementById('pf-description').value = p?.description || '';
  document.getElementById('pf-fabric').value = p?.fabric || '';
  document.getElementById('pf-care').value = p?.care || '';
  document.getElementById('product-modal').classList.add('open');
}

async function saveProduct() {
  const name = document.getElementById('pf-name').value.trim();
  const code = document.getElementById('pf-code').value.trim();
  if (!name || !code) { showToast('Name and code are required', 'error'); return; }

  const payload = {
    name, code,
    price: document.getElementById('pf-price').value.trim(),
    original_price: document.getElementById('pf-original').value.trim(),
    sizes: document.getElementById('pf-sizes').value.trim(),
    status: document.getElementById('pf-status').value,
    description: document.getElementById('pf-description').value.trim(),
    fabric: document.getElementById('pf-fabric').value.trim(),
    care: document.getElementById('pf-care').value.trim(),
  };

  try {
    if (editingProductId) {
      await sb(`products?id=eq.${editingProductId}`, { method:'PATCH', body: JSON.stringify(payload) });
      const idx = allProducts.findIndex(p => p.id === editingProductId);
      if (idx > -1) allProducts[idx] = { ...allProducts[idx], ...payload };
    } else {
      const result = await sb('products', { method:'POST', body: JSON.stringify(payload) });
      if (result) allProducts.unshift(result[0]);
    }
    closeModal('product-modal');
    renderProducts();
    showToast(editingProductId ? 'Product updated âœ“' : 'Product added âœ“');
  } catch(e) { showToast('Failed to save product', 'error'); }
}

async function toggleProductStatus(id, currentStatus) {
  const newStatus = currentStatus === 'active' ? 'hidden' : 'active';
  try {
    await sb(`products?id=eq.${id}`, { method:'PATCH', body: JSON.stringify({ status: newStatus }) });
    const idx = allProducts.findIndex(p => p.id === id);
    if (idx > -1) allProducts[idx].status = newStatus;
    renderProducts();
    showToast(`Product ${newStatus === 'active' ? 'visible' : 'hidden'} âœ“`);
  } catch(e) { showToast('Failed to update', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCustomers(data) {
  const customers = data || allCustomers;
  const tbody = document.getElementById('customers-tbody');

  // Build customers from orders if customers table is empty
  const displayList = customers.length > 0 ? customers : buildCustomersFromOrders();

  if (!displayList.length) { tbody.innerHTML = '<tr><td colspan="8" class="table-empty">No customers yet. They will appear once orders come in.</td></tr>'; return; }

  tbody.innerHTML = displayList.map(c => `
    <tr>
      <td><strong>${esc(c.name)}</strong></td>
      <td>${esc(c.phone||'â€“')}</td>
      <td>${esc(c.email||'â€“')}</td>
      <td style="text-align:center;">${c.total_orders||0}</td>
      <td>${esc(c.preferred_size||'â€“')}</td>
      <td style="font-size:0.75rem;">${c.last_order_at ? formatDate(c.last_order_at) : 'â€“'}</td>
      <td><span class="tag tag-${c.tags||'regular'}">${c.tags||'regular'}</span></td>
      <td><button class="btn-sm" onclick="openCustomerModal('${esc(c.name)}')">View</button></td>
    </tr>
  `).join('');
}

function buildCustomersFromOrders() {
  const map = {};
  allOrders.forEach(o => {
    const key = o.customer_phone || o.customer_email || o.customer_name;
    if (!map[key]) {
      map[key] = { name: o.customer_name, phone: o.customer_phone, email: o.customer_email,
        total_orders: 0, preferred_size: o.size, last_order_at: o.created_at, tags: 'regular', sizes: [] };
    }
    map[key].total_orders++;
    if (o.size) map[key].sizes.push(o.size);
    if (new Date(o.created_at) > new Date(map[key].last_order_at)) map[key].last_order_at = o.created_at;
  });
  return Object.values(map).map(c => ({
    ...c,
    tags: c.total_orders >= 3 ? 'vip' : c.total_orders >= 2 ? 'repeat' : 'regular',
    preferred_size: c.sizes.length ? c.sizes.sort((a,b) =>
      c.sizes.filter(s=>s===b).length - c.sizes.filter(s=>s===a).length)[0] : 'â€“'
  }));
}

function filterCustomers() {
  const q = document.getElementById('customers-search').value.toLowerCase();
  const list = allCustomers.length > 0 ? allCustomers : buildCustomersFromOrders();
  renderCustomers(list.filter(c =>
    (c.name||'').toLowerCase().includes(q) ||
    (c.phone||'').includes(q) ||
    (c.email||'').toLowerCase().includes(q)
  ));
}

function openCustomerModal(name) {
  const orders = allOrders.filter(o => o.customer_name === name);
  const first = orders[0];
  document.getElementById('modal-customer-title').textContent = name;
  document.getElementById('customer-modal-body').innerHTML = `
    <div class="modal-section">
      <div class="modal-section-title">Contact Details</div>
      <div class="modal-grid">
        <div class="info-group"><div class="info-label">Phone</div><div class="info-value">${esc(first?.customer_phone||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Email</div><div class="info-value">${esc(first?.customer_email||'â€“')}</div></div>
        <div class="info-group"><div class="info-label">Total Orders</div><div class="info-value">${orders.length}</div></div>
        <div class="info-group"><div class="info-label">Tag</div><div class="info-value"><span class="tag tag-${orders.length>=3?'vip':orders.length>=2?'repeat':'regular'}">${orders.length>=3?'VIP':orders.length>=2?'Repeat':'Regular'}</span></div></div>
      </div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Order History (${orders.length})</div>
      ${orders.map(o=>`
        <div style="padding:10px;background:var(--bg);margin-bottom:8px;border-left:3px solid var(--gold);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div>
              <div style="font-size:0.82rem;font-weight:400;">${esc(o.product_name)}</div>
              <div style="font-size:0.7rem;color:var(--muted);">${esc(o.product_code||'')} Â· Size ${esc(o.size||'â€“')} Â· Qty ${o.quantity||1}</div>
            </div>
            <div style="text-align:right;">
              <span class="badge badge-${o.status}">${statusLabel(o.status)}</span>
              <div style="font-size:0.68rem;color:var(--muted);margin-top:4px;">${formatDate(o.created_at)}</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  document.getElementById('customer-modal').classList.add('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function statusLabel(s) {
  const map = { new:'New', contacted:'Contacted', confirmed:'Confirmed', payment:'Payment Received',
    production:'In Production', ready:'Ready', delivered:'Delivered', cancelled:'Cancelled' };
  return map[s] || s;
}

function formatDate(d) {
  return new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
}

function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `show ${type}`;
  setTimeout(() => { t.className = ''; }, 3000);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});
</script>
</body>
</html>